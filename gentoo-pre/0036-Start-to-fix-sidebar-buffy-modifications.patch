From 95642c2015f64f6cdb71faeedc3c7aec4e24fe5c Mon Sep 17 00:00:00 2001
From: Kevin McCarthy <kevin@8t8.us>
Date: Sat, 4 Jun 2016 11:32:12 -0700
Subject: [PATCH 36/45] Start to fix sidebar buffy modifications.

The extended buffy for mh had incorrect placement of the loop
brackets.  The counters weren't being incremented in the loop.

Fix extended buffy for maildir to count a maildir message as new if it
doesn't have the info delimeter.

Remove shortcircuits added to the basic buffy stating there is new
mail when (msg_unread > 0).  This is not necessarily true, depending
on $mail_check_recent.

Note: the extended buffy still needs more fixes, which will be done
when it is refactored into its own option.
---
 buffy.c | 13 ++-----------
 1 file changed, 2 insertions(+), 11 deletions(-)

diff --git a/buffy.c b/buffy.c
index 246bee6..64494e3 100644
--- a/buffy.c
+++ b/buffy.c
@@ -342,13 +342,6 @@ static int buffy_maildir_dir_hasnew(BUFFY* mailbox, const char *dir_name)
       return 0;
   }
 
-#ifdef USE_SIDEBAR
-  if (option (OPTSIDEBAR) && mailbox->msg_unread > 0) {
-    mailbox->new = 1;
-    return 1;
-  }
-#endif
-
   if ((dirp = opendir (path)) == NULL)
   {
     mailbox->magic = 0;
@@ -495,6 +488,8 @@ buffy_maildir_update_dir (BUFFY *mailbox, const char *dir)
       if (strchr (p, 'F'))
         mailbox->msg_flagged++;
     }
+    else
+      mailbox->msg_unread++;
   }
 
   closedir (dirp);
@@ -539,11 +534,7 @@ static int buffy_mbox_hasnew (BUFFY* mailbox, struct stat *sb)
   else
     statcheck = sb->st_mtime > sb->st_atime
       || (mailbox->newly_created && sb->st_ctime == sb->st_mtime && sb->st_ctime == sb->st_atime);
-#ifdef USE_SIDEBAR
-  if ((!option (OPTSIDEBAR) && statcheck) || (option (OPTSIDEBAR) && mailbox->msg_unread > 0))
-#else
   if (statcheck)
-#endif
   {
     if (!option(OPTMAILCHECKRECENT) || sb->st_mtime > mailbox->last_visited)
     {
-- 
2.8.2

