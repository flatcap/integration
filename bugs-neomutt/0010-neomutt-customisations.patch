From 9c03c872b5a7b82d2045755da7dc2df8ee951410 Mon Sep 17 00:00:00 2001
From: Richard Russon <rich@flatcap.org>
Date: Fri, 25 Mar 2016 18:30:01 +0000
Subject: [PATCH 10/10] neomutt customisations

---
 ChangeLog.neomutt | 97 +++++++++++++++++++++++++++++++++++++++++++++++++++++++
 Makefile.am       |  5 +--
 README.neomutt    | 79 ++++++++++++++++++++++++++++++++++++++++++++
 VERSION.neo       |  1 +
 doc/Makefile.am   |  4 +--
 globals.h         |  1 +
 init.h            |  9 ++++--
 version.c         | 12 ++++---
 version.sh        |  7 +++-
 9 files changed, 204 insertions(+), 11 deletions(-)
 create mode 100644 ChangeLog.neomutt
 create mode 100644 README.neomutt
 create mode 100644 VERSION.neo
 mode change 100644 => 100755 version.sh

diff --git a/ChangeLog.neomutt b/ChangeLog.neomutt
new file mode 100644
index 0000000..41c2f40
--- /dev/null
+++ b/ChangeLog.neomutt
@@ -0,0 +1,97 @@
+2016-06-11  Richard Russon  <rich@flatcap.org>
+* Change in behaviour
+  - Temporarily disable $sidebar_refresh_time
+    Unfortunately, this was causing too many problems.
+    It will be fixed and re-enabled as soon as possible.
+* Bug Fixes
+  - Fix several crashes, on startup, in Keywords
+  - Reflow text now works as it should
+  - Lots of typos fixed
+  - Compress config bug prevented it working
+  - Some minor bug-fixes from mutt/default
+  - Single quote at line beginning misinterpreted by groff
+  - Setting $sidebar_width to more than 128 would cause bad things to happen.
+  - Fix alignment in the compose menu.
+  - Fix sidebar buffy stats updating on mailbox close.
+* Build Changes
+  - Sync whitespace to mutt/default
+  - Alter ChangeLog date format to simplify Makefiles
+  - Use the new notmuch functions that return a status
+  - Rename sidebar functions sb_* -> mutt_sb_*
+
+2016-05-23  Richard Russon  <rich@flatcap.org>
+* New Features:
+  - Keywords: Email Label/Keywords/Tagging
+  - Compress: Compressed mailboxes support
+  - NNTP: Talk to a usenet news server
+  - Separate mappings for <enter> and <return>
+  - New configure option: --enable-quick-build
+  - Various build fixes
+
+2016-05-02  Richard Russon  <rich@flatcap.org>
+* Update for Mutt-1.6.0
+* Bug Fixes:
+  - Build for Notmuch works if Sidebar is disabled
+  - Sidebar functions work even if the Sidebar is hidden
+  - sidebar-next-new, etc, only find *new* mail, as documented
+  - Notmuch supports *very* long queries
+
+2016-04-16  Richard Russon  <rich@flatcap.org>
+* Big Bugfix Release
+* Bug Fixes:
+  - Fix crash caused by sidebar_folder_indent
+  - Allow the user to change mailboxes again
+  - Correct sidebar's messages counts
+  - Only sort the sidebar if we're asked to
+  - Fix refresh of pager when toggling the sidebar
+  - Compose mode: make messages respect the TITLE_FMT
+  - Conditional include if sys/syscall.h
+  - Build fix for old compilers
+  - Try harder to keep track of the open mailbox
+* Changes to Features
+  - Allow sidebar_divider_char to be longer
+    (it was limited to one character)
+  - Ignore case when sorting the sidebar alphabetically
+* Other Changes
+  - Numerous small tweaks to the docs
+  - Lots of minor code tidy-ups
+  - Enabling NotMuch now forcibly enables Sidebar
+    (it is dependent on it, for now)
+  - A couple of bug fixes from mutt/stable
+
+2016-04-04  Richard Russon  <rich@flatcap.org>
+* Update for Mutt-1.6.0
+* No other changes in this release
+
+2016-03-28  Richard Russon  <rich@flatcap.org>
+* New Features
+  - skip-quoted          - skip quoted text
+  - limit-current-thread - limit index view to current thread
+* Sidebar Intro - A Gentle Introduction to the Sidebar (with pictures).
+
+2016-03-20  Richard Russon  <rich@flatcap.org>
+* Numerous small bugfixes
+* TravisCI integration
+
+2016-03-17  Richard Russon  <rich@flatcap.org>
+* New Features
+  - notmuch - email search support
+  - ifdef   - improvements
+
+2016-03-07  Richard Russon  <rich@flatcap.org>
+* First NeoMutt release
+* List of Features:
+  - bug-fixes    - various bug fixes
+  - cond-date    - use rules to choose date format
+  - fmemopen     - use memory buffers instead of files
+  - ifdef        - conditional config options
+  - index-color  - theme the email index
+  - initials     - expando for author's initials
+  - nested-if    - allow deeply nested conditions
+  - progress     - show a visual progress bar
+  - quasi-delete - mark emails to be hidden
+  - sidebar      - overview of mailboxes
+  - status-color - theming the status bar
+  - tls-sni      - negotiate for a certificate
+  - trash        - move 'deleted' emails to a trash bin
+
diff --git a/Makefile.am b/Makefile.am
index cfdb258..75dea4e 100644
--- a/Makefile.am
+++ b/Makefile.am
@@ -147,8 +147,9 @@ keymap_alldefs.h: $(srcdir)/OPS $(srcdir)/OPS.SIDEBAR $(srcdir)/OPS.NOTMUCH $(sr
 		$(srcdir)/OPS.MIX $(srcdir)/OPS.CRYPT $(srcdir)/OPS.SMIME \
 			> keymap_alldefs.h
 
-reldate.h: $(srcdir)/ChangeLog
-	echo 'const char *ReleaseDate = "'`head -n 1 $(srcdir)/ChangeLog | LC_ALL=C cut -d ' ' -f 1`'";' > reldate.h.tmp; \
+reldate.h: $(top_srcdir)/ChangeLog.neomutt
+	date=`head -n 1 $(top_srcdir)/ChangeLog.neomutt | LC_ALL=C cut -b 1-10` && \
+	echo 'const char *ReleaseDate = "'$$date'";' > reldate.h.tmp; \
 	cmp -s reldate.h.tmp reldate.h || cp reldate.h.tmp reldate.h; \
 	rm reldate.h.tmp
 
diff --git a/README.neomutt b/README.neomutt
new file mode 100644
index 0000000..eeae2cf
--- /dev/null
+++ b/README.neomutt
@@ -0,0 +1,79 @@
+# This is the NeoMutt Project
+
+## What is NeoMutt?
+
+* NeoMutt is a project of projects.
+* A place to gather all the patches against Mutt.
+* A place for all the developers to gather.
+
+Hopefully this will build the community and reduce duplicated effort.
+
+NeoMutt was created when Richard Russon (FlatCap) took all the old Mutt patches,
+sorted through them, fixed them up and documented them.
+
+## What Features does NeoMutt have?
+
+| Name                 | Description
+|----------------------|-------------------------------------------------------
+| Compressed Folders   | Read from/write to compressed mailboxes
+| Conditional Dates    | Conditional Date Formatting
+| Fmemopen             | Use fmemopen(3) for speedier temporary files
+| Ifdef                | Conditional config options
+| Index Color          | Theming of the Index List
+| Initials Expando     | Expando for Author's Initials
+| Keywords             | Labels/Tagging for emails
+| Limit-Current-Thread | Limit Index View to Current Thread
+| Nested If            | Allow deeply nested conditionals in format strings
+| NNTP                 | Talk to a Usenet news server
+| Notmuch              | Powerful email search engine
+| Progress Bar         | Colourful Progress Bar
+| Quasi-Delete         | Hide emails from view, but don't delete them
+| Sidebar              | Panel containing list of Mailboxes
+| Skip-Quoted          | Skip Quoted Text
+| Status Color         | Theming of the Status Bar
+| TLS-SNI              | Negotiate with a Server for a Certificate
+| Trash Folder         | Move 'deleted' emails to a trash folder
+
+## Where is NeoMutt?
+
+- Source Code:     https://github.com/neomutt/neomutt
+- Releases:        https://github.com/neomutt/neomutt/releases/latest
+- Questions/Bugs:  https://github.com/neomutt/neomutt/issues
+- Website:         http://www.neomutt.org/
+- Development:     http://www.neomutt.org/devel/
+
+## NeoMutt Developers
+
+Here's a list of everyone who's helped NeoMutt:
+
+Alex Pearce, Antonio Radici, Christoph Berg, Chris Salzberg, David Sterba,
+Evgeni Golov, Fabian Groffen, Fabio Alessandro Locati, Faidon Liambotis,
+Karel Zak, Kurt Jaeger, Matteo Vescovi, Richard Hartmann, Richard Russon,
+Udo Schweigert, Werner Fink.
+
+## Original Patch Authors
+
+Without the original patch authors, there would be nothing.
+So, a Big Thank You to:
+
+Aaron Schrab, Alain Penders, Benjamin Kuperman, Cedric Duval, Chris Mason,
+Christian Aichinger, Christoph Berg, Christoph Rissner, David Champion,
+David Riebenbauer, David Sterba, David Wilson, Don Zickus, Elimar Riesebieter,
+Eric Davis, Evgeni Golov, Fabian Groffen, Felix von Leitner, Jan Synacek,
+Jason DeTiberus, Jeremiah Foster, Jeremy Katz, Josh Poimboeuf, Julius Plenz,
+Justin Hibbits, Karel Zak, Kirill Shutemov, Luke Macken, Mantas Mikulenas,
+Matteo Vescovi, Patrick Brisbin, Paul Miller, Phil Pennock,
+Philippe Le Brouster, Richard Russon, Rocco Rutte, Roland Rosenfeld, Sami Farin,
+Stefan Assmann, Stefan Kuhn, Steve Kemp, Terry Chan, Thomas Glanzmann,
+Thomer Gil, Tim Stoakes, Tyler Earnest, Victor Manuel Jaquez Leal,
+Vincent Lefevre, Vladimir Marek, Vsevolod Volkov.
+
+## Original Mutt Authors
+
+And of course, we should thank the original Mutt authors, including the original
+author Michael Elkins and all the people that have contributed to Mutt during
+its long history, see the Acknowledgements section of the user manual for a
+detailed list.
+
+http://www.neomutt.org/manual/miscellany.html#acknowledgements
+
diff --git a/VERSION.neo b/VERSION.neo
new file mode 100644
index 0000000..9fcb455
--- /dev/null
+++ b/VERSION.neo
@@ -0,0 +1 @@
+-neo
diff --git a/doc/Makefile.am b/doc/Makefile.am
index 6021626..cd633dc 100644
--- a/doc/Makefile.am
+++ b/doc/Makefile.am
@@ -190,8 +190,8 @@ smime_keys.1: $(srcdir)/smime_keys.man
 
 stamp-doc-xml: makedoc$(EXEEXT) $(top_srcdir)/init.h \
                manual.xml.head $(top_srcdir)/functions.h $(top_srcdir)/OPS* manual.xml.tail \
-               $(srcdir)/gen-map-doc $(top_srcdir)/VERSION $(top_srcdir)/ChangeLog
-	( date=`head -n 1 $(top_srcdir)/ChangeLog | LC_ALL=C cut -d ' ' -f 1` && \
+               $(srcdir)/gen-map-doc $(top_srcdir)/VERSION $(top_srcdir)/ChangeLog.neomutt
+	( date=`head -n 1 $(top_srcdir)/ChangeLog.neomutt | LC_ALL=C cut -b 1-10` && \
 	  sed -e "s/@VERSION\@/`cat $(top_srcdir)/VERSION` ($$date)/" $(srcdir)/manual.xml.head && \
 	  $(MAKEDOC_CPP) $(top_srcdir)/init.h | ./makedoc$(EXEEXT) -s && \
 	  $(MAKEDOC_CPP) $(top_srcdir)/functions.h | \
diff --git a/globals.h b/globals.h
index d4e7fa6..336fa64 100644
--- a/globals.h
+++ b/globals.h
@@ -246,6 +246,7 @@ WHERE short ScoreThresholdFlag;
 
 WHERE short SidebarWidth INITVAL(0);
 #ifdef USE_SIDEBAR
+WHERE short SidebarRefreshTime;
 WHERE LIST *SidebarWhitelist INITVAL(0);
 WHERE int SidebarNeedsRedraw INITVAL (0);
 #endif
diff --git a/init.h b/init.h
index d76e664..b2089f6 100644
--- a/init.h
+++ b/init.h
@@ -1518,7 +1518,7 @@ struct option_t MuttVars[] = {
   ** When \fI$$mark_old\fP is set, Mutt does not consider the mailbox to contain new
   ** mail if only old messages exist.
   */
-  { "mail_check_stats", DT_BOOL, R_NONE, OPTMAILCHECKSTATS, 0 },
+  { "mail_check_stats", DT_BOOL, R_NONE, OPTMAILCHECKSTATS, 1 },
   /*
   ** .pp
   ** When \fIset\fP, mutt will periodically calculate message
@@ -3020,7 +3020,7 @@ struct option_t MuttVars[] = {
   ** .pp
   ** \fBSee also:\fP $$sidebar_short_path, $$sidebar_indent_string, $$sidebar_delim_chars.
   */
-  { "sidebar_format", DT_STR, R_SIDEBAR, UL &SidebarFormat, UL "%B%*  %n" },
+  { "sidebar_format", DT_STR, R_SIDEBAR, UL &SidebarFormat, UL "%B%?F? [%F]?%* %?N?%N/?%S" },
   /*
   ** .pp
   ** This variable allows you to customize the sidebar display. This string is
@@ -3075,6 +3075,11 @@ struct option_t MuttVars[] = {
   ** \fC<sidebar-prev-new>\fP command is similarly affected, wrapping around to
   ** the end of the list.
   */
+  { "sidebar_refresh_time", DT_NUM, R_BOTH, UL &SidebarRefreshTime, 60 },
+  /*
+  ** .pp
+  ** This option is obsolete and will be removed in the next release.
+  */
   { "sidebar_short_path", DT_BOOL, R_SIDEBAR, OPTSIDEBARSHORTPATH, 0 },
   /*
   ** .pp
diff --git a/version.c b/version.c
index f67ae3c..ea5859f 100644
--- a/version.c
+++ b/version.c
@@ -84,8 +84,10 @@ static const char *Obtaining = N_(
 );
 
 static const char *ReachingUs = N_(
-	"To contact the developers, please mail to <mutt-dev@mutt.org>.\n"
-	"To report a bug, please visit http://bugs.mutt.org/.\n"
+	"To learn more about NeoMutt, visit: http://www.neomutt.org/\n"
+	"If you find a bug in NeoMutt, please raise an issue at:\n"
+	"    https://github.com/neomutt/neomutt/issues\n"
+	"or contact the lead developer: Richard Russon <rich@flatcap.org>\n"
 );
 
 static const char *Notice = N_(
@@ -457,9 +459,11 @@ print_version (void)
 	printf ("SYSCONFDIR=\"%s\"\n", SYSCONFDIR);
 	printf ("EXECSHELL=\"%s\"\n", EXECSHELL);
 
-	puts (_(ReachingUs));
-
+	puts ("");
 	mutt_print_patchlist();
+
+	puts ("");
+	puts (_(ReachingUs));
 }
 
 /**
diff --git a/version.sh b/version.sh
old mode 100644
new mode 100755
index d7988df..e4d5c2c
--- a/version.sh
+++ b/version.sh
@@ -1,5 +1,10 @@
 #!/bin/sh
 
+# Switch to directory where this script lives so that further commands are run
+# from the root directory of the source.  The script path and srcdir are double
+# quoted to allow the space character to appear in the path.
+srcdir=`dirname "$0"` && cd "$srcdir" || exit 1
+
 HG=hg
 
 # Switch to directory where this script lives so that further commands are run
@@ -10,7 +15,7 @@ srcdir=`dirname "$0"` && cd "$srcdir" || exit 1
 # Ensure that we have a repo here and that mercurial is installed.  If
 # not, just cat the VERSION file; it contains the latest release number.
 { [ -d ".hg" ] && $HG >/dev/null 2>&1; } \
-|| exec cat VERSION
+|| { cat VERSION* | tr -d \\n; exit; }
 
 # This is a mercurial repo and we have the hg command.
 
-- 
2.9.0

